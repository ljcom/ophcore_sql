CREATE PROCEDURE [dbo].[MaPROD_insert_values]
as	--CreatedBy eLs ON Mar, 2017

	--inserting new product
	insert into MoPROD
		(PRODGUID, Code, Name, Barcode, DIVNGUID, SIGNGUID, SIGNBRANGUID, SIGNAXESGUID, SIGNAXESSUBAGUID, SIGNAXESSUBAFUNCGUID)
	select 
		ItemGUID, ItemCode, ItemName, IsNULL(b.Barcode, b.CommercialCode), 
		c.DIVNGUID, d.SIGNGUID, e.SIGNBRANGUID, f.SIGNAXESGUID, g.SIGNAXESSUBAGUID, h.SIGNAXESSUBAFUNCGUID
	from EF_MAIN.oph.MaPROD a
		inner join EF_MAIN.oph.MaPRODISKU b ON a.ProdGUID = b.ProdGUID
		inner join MoDIVN c ON b.DivisionGUID = c.DIVNGUID
		inner join MoSIGN d ON a.SignatureGUID = d.SIGNGUID AND c.DIVNGUID = d.DIVNGUID
		inner join MoSIGNBRAN e ON a.BrandGUID = e.SIGNBRANGUID AND d.SIGNGUID = e.SIGNGUID
		inner join MoSIGNAXES f ON a.AxeGUID = f.SIGNAXESGUID AND d.SIGNGUID = f.SIGNGUID 
		inner join MoSIGNAXESSUBA g ON f.SIGNAXESGUID = g.SIGNAXESGUID AND LEFT(ProdCode, 2) + SUBSTRING(ProdCode, 11,4) = g.Code
		inner join MoSIGNAXESSUBAFUNC h ON g.SIGNAXESSUBAGUID = h.SIGNAXESSUBAGUID 
			AND SUBSTRING(ProdCode, 11, 4) + RIGHT(ProdCode, 2) = h.Code
		left join MoPROD i ON ItemGUID = i.PRODGUID
	where isNULL(IsNULL(b.Barcode, CommercialCode), '0') != '0' AND i.PRODGUID is NULL

	--updating Menu Category
	update a set 
		a.CTGRGUID = ISNULL(e.CTGRGUID, ISNULL(d.CTGRGUID, (ISNULL(c.CTGRGUID, b.CTGRGUID))))
	--select a.PRODGUID, ISNULL(e.CTGRGUID, ISNULL(d.CTGRGUID, (ISNULL(c.CTGRGUID, b.CTGRGUID)))) [CTGRGUID], b.CTGRGUID [Axe], SIGNAXESGUIDcbNm, c.CTGRGUID [SubAxe], SIGNAXESSUBAGUIDcbNm, d.CTGRGUID [Func], SIGNAXESSUBAFUNCGUIDcbNm,  e.CTGRGUID [Signa], SIGNGUIDcbNm
	from oph.MaPROD a
		left join MoCTGR_1 b ON a.SIGNAXESGUIDcbNm = b.Name
		left join MoCTGR_2 c ON a.SIGNAXESSUBAGUIDcbNm = c.Name AND b.CTGRGUID = c.PARNCTGRGUID
		left join MoCTGR_3 d ON a.SIGNAXESSUBAFUNCGUIDcbNm = d.Name AND c.CTGRGUID = d.PARNCTGRGUID
		left join MoCTGR_4 e ON a.SIGNGUIDcbNm = e.Name AND d.CTGRGUID = e.PARNCTGRGUID
	where a.CTGRGUID is NULL

	--updating Menu Brand
	update a set 
		a.BRANGUID = ISNULL(e.BRANGUID, ISNULL(d.BRANGUID, (ISNULL(c.BRANGUID, b.BRANGUID))))
	--select a.PRODGUID, ISNULL(e.BRANGUID, ISNULL(d.BRANGUID, (ISNULL(c.BRANGUID, b.BRANGUID)))) [CTGRGUID], b.BRANGUID [Div], DIVNGUIDcbNm, c.BRANGUID [Signa], SIGNGUIDcbNm, d.BRANGUID [Axe], SIGNAXESGUIDcbNm,  e.BRANGUID [Func], SIGNAXESSUBAFUNCGUIDcbNm
	from oph.MaPROD a
		left join MoBRAN_1 b ON a.DIVNGUIDcbNm = b.Name
		left join MoBRAN_2 c ON a.SIGNGUIDcbNm = c.Name AND b.BRANGUID = c.PARNBRANGUID
		left join MoBRAN_3 d ON a.SIGNAXESGUIDcbNm = d.Name AND c.BRANGUID = d.PARNBRANGUID
		left join MoBRAN_4 e ON a.SIGNAXESSUBAFUNCGUIDcbNm = e.Name AND d.BRANGUID = e.PARNBRANGUID
	where a.BRANGUID is NULL
	


